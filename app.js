const STORAGE_KEY='bm_expenses',CATEGORY_KEY='bm_categories',SETTINGS_KEY='bm_settings',COLOR_GREEN='rgba(34,197,94,0.8)',COLOR_RED='rgba(239,68,68,0.8)',COLOR_NEUTRAL='rgba(59,130,246,0.5)';let monthOffset=0,currentFilter={period:'all',category:'all',from:null,to:null};function loadJSON(e,t){const n=localStorage.getItem(e);if(!n)return t;try{return JSON.parse(n)}catch(e){return t}}function saveJSON(e,t){localStorage.setItem(e,JSON.stringify(t))}function loadExpenses(){return loadJSON(STORAGE_KEY,[])}function saveExpenses(e){saveJSON(STORAGE_KEY,e)}function loadCategories(){return loadJSON(CATEGORY_KEY,[])}function saveCategories(e){saveJSON(CATEGORY_KEY,e)}function loadSettings(){return loadJSON(SETTINGS_KEY,{dailyBudget:null,monthlyBudget:null,darkMode:!1})}function saveSettings(e){saveJSON(SETTINGS_KEY,e)}function addExpense(e,t,n,a){const o=loadExpenses(),r=Date.now()+Math.random();o.push({id:r,date:e,amount:t,category:n,note:a||''}),saveExpenses(o);const s=loadCategories(),d=(n||'').trim();d&&!s.includes(d)&&(s.push(d),saveCategories(s))}function deleteExpense(e){let t=loadExpenses();t=t.filter((t=>t.id!==e)),saveExpenses(t)}function pad2(e){return String(e).padStart(2,'0')}function todayDate(){const e=new Date;return e.toISOString().slice(0,10)}function getSelectedMonthDate(){const e=new Date;return e.setDate(1),e.setMonth(e.getMonth()+monthOffset),e}function getSelectedMonthKey(){const e=getSelectedMonthDate();return e.getFullYear()+'-'+pad2(e.getMonth()+1)}function getSelectedMonthLabel(){const e=getSelectedMonthDate(),t=e.toLocaleString(void 0,{month:'long'});return t+' '+e.getFullYear()}function getCurrentMonthKey(){const e=new Date;return e.getFullYear()+'-'+pad2(e.getMonth()+1)}function getCurrentWeekRange(){const e=new Date,t=e.getDay(),n=0===t?-6:1-t,a=new Date(e);a.setDate(e.getDate()+n);const o=new Date(a);return o.setDate(a.getDate()+6),{start:a,end:o}}function filterSelectedMonth(e){const t=getSelectedMonthKey();return e.filter((e=>(e.date||'').startsWith(t)))}function filterCurrentDay(e){const t=todayDate();return e.filter((e=>e.date===t))}function filterCurrentWeek(e){const{start:t,end:n}=getCurrentWeekRange();return e.filter((e=>{if(!e.date)return!1;const a=new Date(e.date);return a>=t&&a<=n}))}function getFilteredExpenses(){let e=loadExpenses();if('day'===currentFilter.period)e=filterCurrentDay(e);else if('week'===currentFilter.period)e=filterCurrentWeek(e);else if('month'===currentFilter.period)e=filterSelectedMonth(e);else if('range'===currentFilter.period&&(currentFilter.from||currentFilter.to)){const t=currentFilter.from?new Date(currentFilter.from):null,n=currentFilter.to?new Date(currentFilter.to):null;e=e.filter((e=>{if(!e.date)return!1;const a=new Date(e.date);if(t&&a<t)return!1;if(n){const e=new Date(n);if(e.setHours(23,59,59,999),a>e)return!1}return!0}))}return'all'!==currentFilter.category&&(e=e.filter((e=>(e.category||'')===currentFilter.category))),e}function buildMonthlyData(e){const t={};return e.forEach((e=>{if(!e.date)return;const n=e.date.slice(8,10);t[n]=(t[n]||0)+Number(e.amount||0)})),{days:Object.keys(t).sort(),values:Object.keys(t).sort().map((e=>t[e]))}}function buildCategoryData(e){const t={};return e.forEach((e=>{const n=e.category&&e.category.trim()?e.category.trim():'Uncategorized';t[n]=(t[n]||0)+Number(e.amount||0)})),{labels:Object.keys(t),values:Object.keys(t).map((e=>t[e]))}}function buildTrendData(e){const t={};return e.forEach((e=>{if(!e.date)return;const n=e.date.slice(0,7);t[n]=(t[n]||0)+Number(e.amount||0)})),{labels:Object.keys(t).sort().slice(-6),values:Object.keys(t).sort().slice(-6).map((e=>t[e]))}}function currentMonthTotal(e){return filterSelectedMonth(e).reduce(((e,t)=>e+Number(t.amount||0)),0)}function buildYearlyData(e,t,n){const a=[],o=[],r=[],s=[],d=[];let l=0,c=-1/0,i=1/0,u=null,m=null;for(let f=0;f<12;f++){const g=t+'-'+pad2(f+1),y=e.filter((e=>(e.date||'').startsWith(g))).reduce(((e,t)=>e+Number(t.amount||0)),0);if(a.push(new Date(t,f,1).toLocaleString(void 0,{month:'short'})),o.push(y),l+=y,y>c&&(c=y,m=f),y<i&&(i=y,u=f),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(l)&&(l=0),!isFinite(y)&&(y=0),!isFinite(f)&&(f=0),!isFinite(t)&&(t=0),!isFinite(g)&&(g=0),!isFinite(y)&&(y=0),!isFinite(l)&&(l=0),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(f)&&(f=0),!isFinite(t)&&(t=0),!isFinite(g)&&(g=0),!isFinite(y)&&(y=0),!isFinite(l)&&(l=0),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(f)&&(f=0),!isFinite(t)&&(t=0),!isFinite(g)&&(g=0),!isFinite(y)&&(y=0),!isFinite(l)&&(l=0),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(f)&&(f=0),!isFinite(t)&&(t=0),!isFinite(g)&&(g=0),!isFinite(y)&&(y=0),!isFinite(l)&&(l=0),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(f)&&(f=0),!isFinite(t)&&(t=0),!isFinite(g)&&(g=0),!isFinite(y)&&(y=0),!isFinite(l)&&(l=0),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(f)&&(f=0),!isFinite(t)&&(t=0),!isFinite(g)&&(g=0),!isFinite(y)&&(y=0),!isFinite(l)&&(l=0),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(f)&&(f=0),!isFinite(t)&&(t=0),!isFinite(g)&&(g=0),!isFinite(y)&&(y=0),!isFinite(l)&&(l=0),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(f)&&(f=0),!isFinite(t)&&(t=0),!isFinite(g)&&(g=0),!isFinite(y)&&(y=0),!isFinite(l)&&(l=0),!isFinite(c)&&(c=0),!isFinite(i)&&(i=0),!isFinite(f)&&(f=0)){const e=new Date(t,f+1,0).getDate();let a=null;n.monthlyBudget?a=Number(n.monthlyBudget):n.dailyBudget&&(a=Number(n.dailyBudget)*e),s.push(a),null!=a?(d.push(y-a),r.push(y<=a?COLOR_GREEN:COLOR_RED)):(d.push(null),r.push(COLOR_NEUTRAL))}return isFinite(c)||(c=0),isFinite(i)||(i=0),{labels:a,values:o,colors:r,budgets:s,diffs:d,totalYear:l,avgMonth:l/12,maxVal:c,minVal:i,maxMonthLabel:null!=m?new Date(t,m,1).toLocaleString(void 0,{month:'long'}):'-',minMonthLabel:null!=u?new Date(t,u,1).toLocaleString(void 0,{month:'long'}):'-'}}function getMondayOfDate(e){const t=e.getDay(),n=0===t?-6:1-t,a=new Date(e);return a.setDate(e.getDate()+n),a.setHours(0,0,0,0),a}function buildWeeklyData(e){const t=new Date,n=getMondayOfDate(t),a=[],o=[];let r=0,s=-1/0,d=1/0,l=null,c=null;for(let t=11;t>=0;t--){const i=new Date(n);i.setDate(i.getDate()-7*t);const u=new Date(i);u.setDate(i.getDate()+6);const m=e.filter((e=>{if(!e.date)return!1;const t=new Date(e.date);return t>=i&&t<=u})).reduce(((e,t)=>e+Number(t.amount||0)),0),f=i.toLocaleDateString(void 0,{day:'2-digit',month:'2-digit'})+' - '+u.toLocaleDateString(void 0,{day:'2-digit',month:'2-digit'});a.push(f),o.push(m),r+=m,m>s&&(s=m,c=a.length-1),m<d&&(d=m,l=a.length-1)}return isFinite(s)||(s=0),isFinite(d)||(d=0),{labels:a,values:o,total:r,avgWeek:r/12,bestLabel:null!=l?a[l]:'-',worstLabel:null!=c?a[c]:'-',bestVal:d,worstVal:s}}let monthlyChart,catMonthChart,catWeekChart,catDayChart,trendChart,yearlyChart,weeklyChart;function renderCategoryList(){const e=loadCategories().slice().sort(((e,t)=>e.localeCompare(t))),t=document.getElementById('categoryList');t&&(t.innerHTML='',e.forEach((e=>{const n=document.createElement('option');n.value=e,t.appendChild(n)})))}function renderCategoryManager(){const e=document.getElementById('categoryManager');if(!e)return;const t=loadCategories().slice().sort(((e,t)=>e.localeCompare(t)));t.length?(e.innerHTML='',t.forEach((t=>{const n=document.createElement('div');n.className='cat-item';const a=document.createElement('span');a.textContent=t;const o=document.createElement('div');o.className='cat-item-buttons';const r=document.createElement('button');r.textContent='Rename',r.className='cat-item-btn',r.addEventListener('click',(()=>{const n=prompt('New name for category:',t);if(!n)return;const a=n.trim();if(!a)return;const o=loadCategories(),r=o.indexOf(t);r>=0&&(o[r]=a),saveCategories(o);const s=loadExpenses();s.forEach((e=>{(e.category||'').trim()===t&&(e.category=a)})),saveExpenses(s),renderCategoryList(),renderCategoryManager(),renderCharts(),renderExpenseTable()}));const s=document.createElement('button');s.textContent='Delete',s.className='cat-item-btn',s.addEventListener('click',(()=>{if(!confirm('Delete this category from suggestions? Existing expenses keep their category.'))return;const n=loadCategories().filter((e=>e!==t));saveCategories(n),renderCategoryList(),renderCategoryManager()})),o.appendChild(r),o.appendChild(s),n.appendChild(a),n.appendChild(o),e.appendChild(n)}))):e.textContent='No saved categories yet. They will appear here once you use them.'}function renderMonthLabel(){const e=document.getElementById('monthLabel'),t=document.getElementById('prevMonth'),n=document.getElementById('nextMonth');e&&(e.textContent=getSelectedMonthLabel()),n&&(n.disabled=monthOffset>=0),t&&(t.disabled=!1),syncMonthYearSelectors()}function updateMonthSummary(e,t){const n=document.getElementById('monthSummary');if(!n)return;const a=getSelectedMonthDate(),o=new Date,r=a.getFullYear(),s=a.getMonth(),d=o.getFullYear(),l=o.getMonth(),c=new Date(r,s+1,0).getDate();let i;r<d||r===d&&s<l?i=c:r===d&&s===l?i=o.getDate():i=c;const u=e.reduce(((e,t)=>e+Number(t.amount||0)),0);let m=null;t.monthlyBudget?m=Number(t.monthlyBudget):t.dailyBudget&&(m=Number(t.dailyBudget)*i);let f=`Sum: ${u.toFixed(2)} € • Days: ${i}`;null!=m&&(f+=` • Budget: ${m.toFixed(2)} €`,u<=m?(f+=' • Under budget',n.className='hint summary-ok'):(f+=' • OVER budget',n.className='hint summary-warn')),null==m&&(n.className='hint'),n.textContent=f}function updateMonthChangeAndProjection(e,t){const n=document.getElementById('monthChange'),a=document.getElementById('monthProjection');n&&(n.textContent='',n.className='hint'),a&&(a.textContent='',a.className='hint');const o=loadExpenses();if(n){const e=getSelectedMonthDate(),t=new Date(e);t.setMonth(t.getMonth()-1);const a=t.getFullYear()+'-'+pad2(t.getMonth()+1),r=getSelectedMonthKey(),s=o.filter((e=>(e.date||'').startsWith(r))).reduce(((e,t)=>e+Number(t.amount||0)),0),d=o.filter((e=>(e.date||'').startsWith(a))).reduce(((e,t)=>e+Number(t.amount||0)),0);if(0===d)n.textContent='Change vs previous month: no previous month data.',n.className='hint';else{const e=s-d,t=e>0?'↑':e<0?'↓':'→',a=Math.abs(e).toFixed(2);e>0?(n.textContent=`Change vs previous month: +${a} € (${t})`,n.className='hint summary-warn'):e<0?(n.textContent=`Change vs previous month: -${a} € (${t})`,n.className='hint summary-ok'):(n.textContent=`Change vs previous month: 0.00 € (${t})`,n.className='hint')}}if(a){const n=new Date,o=getSelectedMonthDate();if(o.getFullYear()===n.getFullYear()&&o.getMonth()===n.getMonth()){const r=new Date(o.getFullYear(),o.getMonth()+1,0).getDate(),s=n.getDate();if(s>0){const n=e.filter((e=>{if(!e.date)return!1;return parseInt(e.date.slice(8,10),10)<=s})).reduce(((e,t)=>e+Number(t.amount||0)),0),d=n/s,l=d*r;let c=null;t.monthlyBudget?c=Number(t.monthlyBudget):t.dailyBudget&&(c=Number(t.dailyBudget)*r);let i=`Projected total for this month: ${l.toFixed(2)} € (based on average daily spending)`;null!=c&&(l<=c?(i+=` • within budget (${c.toFixed(2)} €)`,a.className='hint summary-ok'):(i+=` • would OVER budget (${c.toFixed(2)} €)`,a.className='hint summary-warn')),a.textContent=i}}else a.textContent='Projection is only available for the current month.',a.className='hint'}}function renderFavoriteCategories(){const e=document.getElementById('favCategories');if(!e)return;const t=loadExpenses();if(!t.length){e.textContent='';return}const n=new Date,a=new Date(n);a.setDate(n.getDate()-30);const o={};t.forEach((e=>{if(!e.date)return;const t=new Date(e.date);if(t<a)return;const n=(e.category||'').trim();n&&(o[n]=(o[n]||0)+1)}));const r=Object.entries(o).sort(((e,t)=>t[1]-e[1])).slice(0,7);e.innerHTML='',r.forEach((t=>{const n=t[0],a=document.createElement('button');a.type='button',a.className='cat-btn',a.textContent=n,a.setAttribute('data-cat',n),a.addEventListener('click',(()=>{const e=document.getElementById('category');e&&(e.value=n)})),e.appendChild(a)}))}function renderCharts(){const e=loadExpenses(),t=filterSelectedMonth(e),n=t,a=filterCurrentWeek(e),o=filterCurrentDay(e),r=buildMonthlyData(t),s=buildCategoryData(n),d=buildCategoryData(a),l=buildCategoryData(o),c=buildTrendData(e),i=loadSettings(),u=document.getElementById('monthlyChart'),m=document.getElementById('catMonthChart'),f=document.getElementById('catWeekChart'),g=document.getElementById('catDayChart'),y=document.getElementById('trendChart'),h=document.getElementById('yearlyChart'),p=document.getElementById('weeklyChart');if(!u||!m||!f||!g||!y||!h||!p||'undefined'==typeof Chart)return;monthlyChart&&monthlyChart.destroy(),catMonthChart&&catMonthChart.destroy(),catWeekChart&&catWeekChart.destroy(),catDayChart&&catDayChart.destroy(),trendChart&&trendChart.destroy(),yearlyChart&&yearlyChart.destroy(),weeklyChart&&weeklyChart.destroy();let v=r.values.map((()=>COLOR_NEUTRAL));if(i.dailyBudget){const e=Number(i.dailyBudget);v=r.values.map((t=>t<=e?COLOR_GREEN:COLOR_RED))}monthlyChart=new Chart(u,{type:'bar',data:{labels:r.days,datasets:[{label:'Daily Spending (€)',data:r.values,backgroundColor:v}]}}),catMonthChart=new Chart(m,{type:'doughnut',data:{labels:s.labels,datasets:[{data:s.values}]}}),catWeekChart=new Chart(f,{type:'doughnut',data:{labels:d.labels,datasets:[{data:d.values}]}}),catDayChart=new Chart(g,{type:'doughnut',data:{labels:l.labels,datasets:[{data:l.values}]}});const b=currentMonthTotal(e),k=getSelectedMonthDate(),E=new Date(k.getFullYear(),k.getMonth()+1,0).getDate();let x=null;i.monthlyBudget?x=Number(i.monthlyBudget):i.dailyBudget&&(x=Number(i.dailyBudget)*E);let w=COLOR_NEUTRAL;null!=x&&(w=b<=x?COLOR_GREEN:COLOR_RED),trendChart=new Chart(y,{type:'line',data:{labels:c.labels,datasets:[{label:'Monthly Total (€)',data:c.values,borderColor:w,backgroundColor:w,tension:.2}]}}),renderMonthLabel(),updateMonthSummary(t,i),updateMonthChangeAndProjection(t,i);const C=k.getFullYear(),T=buildYearlyData(e,C,i);yearlyChart=new Chart(h,{type:'bar',data:{labels:T.labels,datasets:[{label:'Monthly total (€)',data:T.values,backgroundColor:T.colors}]}});const M=document.getElementById('yearSummary');M&&(M.textContent=`Year ${C}: Total ${T.totalYear.toFixed(2)} € • Avg/month ${T.avgMonth.toFixed(2)} € • Highest: ${T.maxMonthLabel} (${T.maxVal.toFixed(2)} €) • Lowest: ${T.minMonthLabel} (${T.minVal.toFixed(2)} €)`);const B=document.getElementById('yearTable');if(B){let e='<table><thead><tr><th>Month</th><th>Sum (€)</th><th>Budget (€)</th><th>Diff (€)</th><th>Status</th></tr></thead><tbody>';for(let n=0;n<12;n++){const a=T.labels[n],o=T.values[n],r=T.budgets[n],s=T.diffs[n];let d='',l='';null==r||null==s?d='-':s<=0?(d='Under',l='status-ok'):(d='Over',l='status-warn'),e+=`<tr><td>${a}</td><td>${o.toFixed(2)}</td><td>${null!=r?r.toFixed(2):'-'}</td><td>${null!=s?s.toFixed(2):'-'}</td><td class="${l}">${d}</td></tr>`}e+='</tbody></table>',B.innerHTML=e}const D=buildWeeklyData(e);weeklyChart=new Chart(p,{type:'bar',data:{labels:D.labels,datasets:[{label:'Weekly total (€)',data:D.values,backgroundColor:COLOR_NEUTRAL}]}});const S=document.getElementById('weekSummary');if(S){let e=`Best (lowest): ${D.bestLabel} (${D.bestVal.toFixed(2)} €)`,t=`Worst (highest): ${D.worstLabel} (${D.worstVal.toFixed(2)} €)`;S.textContent=`Last 12 weeks: Total ${D.total.toFixed(2)} € • Avg/week ${D.avgWeek.toFixed(2)} € • ${e} • ${t}`}renderFavoriteCategories()}function renderExpenseTable(){const e=document.querySelector('#expenseTable tbody'),t=document.getElementById('summaryBar');if(!e||!t)return;const n=loadSettings(),a=getFilteredExpenses();e.innerHTML='';let o=0;a.sort(((e,t)=>(e.date||'').localeCompare(t.date||''))),a.forEach((t=>{o+=Number(t.amount||0);const n=document.createElement('tr');n.innerHTML=`<td>${t.date||''}</td><td>${t.category||''}</td><td>${Number(t.amount||0).toFixed(2)}</td><td><button class="del-btn" data-id="${t.id}">Del</button></td>`,e.appendChild(n)}));let r='All data';'day'===currentFilter.period?r='Today':'week'===currentFilter.period?r='This week':'month'===currentFilter.period?r='This month':'range'===currentFilter.period&&(r='Custom range');let s='';'all'!==currentFilter.category&&(s=`, category: ${currentFilter.category}`);let d=`Filter: ${r}${s} • Total: ${o.toFixed(2)} €`,l='summary-ok';if('month'===currentFilter.period&&n.monthlyBudget){const e=Number(n.monthlyBudget),t=e-o;t>=0?(d+=` • ${t.toFixed(2)} € under monthly budget`,l='summary-ok'):(d+=` • ${Math.abs(t).toFixed(2)} € OVER monthly budget`,l='summary-warn')}t.textContent=d,t.className='summary-bar '+l}function renderBudgetInfo(){const e=document.getElementById('budgetInfo'),t=document.getElementById('cumBudgetBox');if(!e||!t)return;const n=loadSettings(),a=loadExpenses(),o=getCurrentMonthKey(),r=a.filter((e=>(e.date||'').startsWith(o))).reduce(((e,t)=>e+Number(t.amount||0)),0),s=new Date,d=s.getFullYear(),l=s.getMonth(),c=s.getDate(),i=new Date(d,l+1,0).getDate(),u=Math.max(0,i-c+1);let m='',f=null;n.monthlyBudget?(f=Number(n.monthlyBudget)-r,m='based on monthly budget'):n.dailyBudget&&(f=Number(n.dailyBudget)*u-r,m='based on projected daily budget');let g=[];n.dailyBudget&&g.push(`Daily: ${Number(n.dailyBudget).toFixed(2)} €`),n.monthlyBudget&&g.push(`Monthly: ${Number(n.monthlyBudget).toFixed(2)} €`),null!=f&&g.push(`Remaining this month: ${f.toFixed(2)} € (${m})`),e.textContent=g.join(' • '),t.textContent='',t.className='cum-box',n.dailyBudget&&(t.style.display='inline-block',t.textContent='',function(){const e=a.filter((e=>{if(!e.date)return!1;return(e.date||'').startsWith(o)})),r=e.filter((e=>{if(!e.date)return!1;return parseInt(e.date.slice(8,10),10)<=c})).reduce(((e,t)=>e+Number(t.amount||0)),0),s=Number(n.dailyBudget)*c,d=s-r;let l=`Cumulative spending: ${r.toFixed(2)} € • Allowed so far (${c} days): ${s.toFixed(2)} €`;d>=0?(l+=` • Status: under by ${d.toFixed(2)} €`,t.className='cum-box cum-ok'):(l+=` • Status: OVER by ${Math.abs(d).toFixed(2)} €`,t.className='cum-box cum-warn'),t.textContent=l}())}async function printReport(){const e=document.querySelector('.container');if(!e){alert('Nothing to print.');return}if(!window.html2canvas||!window.jspdf){alert('Print libraries not available. Please ensure html2canvas & jsPDF are loaded.');return}try{const t=await html2canvas(e,{scale:2}),n=t.toDataURL('image/png'),{jsPDF:a}=window.jspdf,o=new a('p','mm','a4'),r=o.internal.pageSize.getWidth(),s=o.internal.pageSize.getHeight(),d=r,l=t.height*r/t.width;if(l<=s)o.addImage(n,'PNG',0,0,d,l);else{let e=l,t=0;for(o.addImage(n,'PNG',0,t,d,l),e-=s;e>0;)o.addPage(),t-=s,o.addImage(n,'PNG',0,t,d,l),e-=s}const c=(new Date).toISOString().slice(0,10);o.save('BudgetMate_Report_'+c+'.pdf')}catch(e){console.error(e),alert('Error while generating PDF: '+e.message)}}async function exportMonthPdf(){const e=document.getElementById('monthlySection');if(!e){alert('Nothing to export.');return}if(!window.html2canvas||!window.jspdf){alert('Export libraries not available. Please ensure html2canvas & jsPDF are loaded.');return}try{const t=await html2canvas(e,{scale:2}),n=t.toDataURL('image/png'),{jsPDF:a}=window.jspdf,o=new a('p','mm','a4'),r=o.internal.pageSize.getWidth(),s=o.internal.pageSize.getHeight(),d=r,l=t.height*r/t.width;if(l<=s)o.addImage(n,'PNG',0,0,d,l);else{let e=l,t=0;for(o.addImage(n,'PNG',0,t,d,l),e-=s;e>0;)o.addPage(),t-=s,o.addImage(n,'PNG',0,t,d,l),e-=s}const c=getSelectedMonthDate(),i=c.toLocaleString(void 0,{month:'long'}),u=c.getFullYear();o.save(`BudgetMate_Month_${i}_${u}.pdf`)}catch(e){console.error(e),alert('Error while generating month PDF: '+e.message)}}function openFilterModal(){const e=document.getElementById('filterModal'),t=document.getElementById('filterPeriod'),n=document.getElementById('filterCategory'),a=document.getElementById('filterFrom'),o=document.getElementById('filterTo');if(!e||!t||!n||!a||!o)return;t.value=currentFilter.period,a.value=currentFilter.from||'',o.value=currentFilter.to||'';const r=loadExpenses(),s=[...new Set(r.map((e=>(e.category||'').trim())).filter(Boolean))].sort(((e,t)=>e.localeCompare(t)));n.innerHTML='';const d=document.createElement('option');d.value='all',d.textContent='All categories',n.appendChild(d),s.forEach((e=>{const t=document.createElement('option');t.value=e,t.textContent=e,n.appendChild(t)})),n.value='all'===currentFilter.category?'all':currentFilter.category,e.classList.remove('hidden')}function closeFilterModal(){const e=document.getElementById('filterModal');e&&e.classList.add('hidden')}function populateMonthYearSelectors(){const e=document.getElementById('monthSelect'),t=document.getElementById('yearSelect');if(!e||!t)return;const n=[];for(let e=0;e<12;e++)n.push((new Date(2e3,e,1)).toLocaleString(void 0,{month:'short'}));e.innerHTML='',n.forEach(((t,n)=>{const a=document.createElement('option');a.value=n,a.textContent=t,e.appendChild(a)}));const a=new Date,o=a.getFullYear(),r=o-10;t.innerHTML='';for(let e=o;e>=r;e--){const n=document.createElement('option');n.value=e,n.textContent=e,t.appendChild(n)}syncMonthYearSelectors()}function syncMonthYearSelectors(){const e=document.getElementById('monthSelect'),t=document.getElementById('yearSelect');if(!e||!t)return;const n=getSelectedMonthDate();e.value=n.getMonth(),t.value=n.getFullYear()}function setMonthYearFromSelectors(){const e=document.getElementById('monthSelect'),t=document.getElementById('yearSelect');if(!e||!t)return;const n=parseInt(e.value,10),a=parseInt(t.value,10);if(!isFinite(n)||!isFinite(a))return;const o=new Date,r=o.getFullYear(),s=o.getMonth(),d=12*(a-r)+(n-s);monthOffset=d,renderCharts(),renderExpenseTable()}document.addEventListener('DOMContentLoaded',(()=>{const e=document.getElementById('expenseForm'),t=document.getElementById('date');t&&(t.value=todayDate());const n=loadSettings();document.body.classList.toggle('dark',!!n.darkMode);const a=document.getElementById('dailyBudget'),o=document.getElementById('monthlyBudget');a&&(a.value=null!=n.dailyBudget?n.dailyBudget:''),o&&(o.value=null!=n.monthlyBudget?n.monthlyBudget:'');const r=document.getElementById('darkToggle');r&&(r.textContent=n.darkMode?'Light mode':'Dark mode'),populateMonthYearSelectors(),renderBudgetInfo(),renderCategoryList(),renderCategoryManager(),renderCharts(),renderExpenseTable(),document.querySelectorAll('.cat-btn').forEach((e=>{e.addEventListener('click',(()=>{const t=e.getAttribute('data-cat'),n=document.getElementById('category');n&&(n.value=t)}))})),r&&r.addEventListener('click',(()=>{const e=loadSettings();e.darkMode=!e.darkMode,saveSettings(e),document.body.classList.toggle('dark',!!e.darkMode),r.textContent=e.darkMode?'Light mode':'Dark mode'}));const s=document.getElementById('saveBudget');s&&s.addEventListener('click',(()=>{const e=loadSettings(),n=document.getElementById('dailyBudget').value,a=document.getElementById('monthlyBudget').value;e.dailyBudget=n?parseFloat(n):null,e.monthlyBudget=a?parseFloat(a):null,saveSettings(e),renderBudgetInfo(),renderExpenseTable(),renderCharts(),alert('Budget saved.')}));const d=document.querySelector('#expenseTable tbody');d&&d.addEventListener('click',(e=>{const t=e.target;if(t&&t.classList.contains('del-btn')){const e=t.getAttribute('data-id');if(!e)return;if(!confirm('Do you really want to delete?\n\nYes = delete this single expense.\nNo = keep it.'))return;const n=Number(e);deleteExpense(n),renderCharts(),renderExpenseTable(),renderBudgetInfo()}}));const l=document.getElementById('deleteAll');l&&l.addEventListener('click',(()=>{if(!confirm('DELETE ALL EXPENSE DATA\n\nThis will delete:\n• all saved expenses\n• all saved categories\n\nBudgets & settings will stay.\n\nAre you sure?\nYes = delete all\nNo = cancel'))return;saveExpenses([]),saveCategories([]),renderCategoryList(),renderCategoryManager(),renderCharts(),renderExpenseTable(),renderBudgetInfo()}));const c=document.getElementById('newRules');c&&c.addEventListener('click',(()=>{if(!confirm('Do you really want to change the rules?'))return;const e=document.getElementById('rulesCard');e&&e.scrollIntoView({behavior:'smooth'}),alert('You can now adjust categories in the "Rules & Settings" section. Budgets can be changed in the Budget section at the top.')}));const i=document.getElementById('printReport');i&&i.addEventListener('click',(()=>{printReport()}));const u=document.getElementById('exportMonthPdf');u&&u.addEventListener('click',(()=>{exportMonthPdf()}));const m=document.getElementById('thDate'),f=document.getElementById('thCategory');m&&m.addEventListener('click',openFilterModal),f&&f.addEventListener('click',openFilterModal);const g=document.getElementById('filterModal'),y=document.getElementById('closeFilter'),h=document.getElementById('applyFilter'),p=document.getElementById('clearFilter'),v=document.getElementById('filterPeriod'),b=document.getElementById('filterCategory'),k=document.getElementById('filterFrom'),E=document.getElementById('filterTo');y&&y.addEventListener('click',(()=>{closeFilterModal()})),g&&g.querySelector('.modal-backdrop')&&g.querySelector('.modal-backdrop').addEventListener('click',(()=>{closeFilterModal()})),h&&h.addEventListener('click',(()=>{v&&(currentFilter.period=v.value),b&&(currentFilter.category=b.value),'range'===v.value?(currentFilter.from=k.value||null,currentFilter.to=E.value||null):(currentFilter.from=null,currentFilter.to=null),closeFilterModal(),renderCharts(),renderExpenseTable()})),p&&p.addEventListener('click',(()=>{currentFilter={period:'all',category:'all',from:null,to:null},closeFilterModal(),renderCharts(),renderExpenseTable()}));const x=document.getElementById('prevMonth'),w=document.getElementById('nextMonth'),C=document.getElementById('todayMonth'),T=document.getElementById('monthSelect'),M=document.getElementById('yearSelect');x&&x.addEventListener('click',(()=>{monthOffset--,renderCharts(),renderExpenseTable()})),w&&w.addEventListener('click',(()=>{monthOffset<0&&(monthOffset++,renderCharts(),renderExpenseTable())})),C&&C.addEventListener('click',(()=>{monthOffset=0,renderCharts(),renderExpenseTable()})),T&&T.addEventListener('change',(()=>{setMonthYearFromSelectors()})),M&&M.addEventListener('change',(()=>{setMonthYearFromSelectors()})),e&&e.addEventListener('submit',(n=>{n.preventDefault();const a=t.value,o=document.getElementById('amount').value,r=document.getElementById('category').value,s=document.getElementById('note').value;if(!a||!o||!r){alert('Please fill in date, amount and category.');return}const d=parseFloat(o);if(!isFinite(d)||d<=0){alert('Amount must be a positive number.');return}addExpense(a,d,r,s),e.reset(),t.value=todayDate(),renderCategoryList(),renderCategoryManager(),renderCharts(),renderExpenseTable(),renderBudgetInfo()}))}));